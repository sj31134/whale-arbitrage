# 자동매매 봇 개발 계획

## 프로젝트 개요

기존 프로젝트의 분석 결과를 활용한 데이터 기반 자동매매 봇을 개발합니다. 
**중요**: 기존 데이터 수집 DB와 분석 서비스 메뉴에 영향을 주지 않도록 완전히 독립적인 모듈로 개발합니다.

## 프로젝트 구조

```
whale_tracking/
├── trading_bot/                    # 새로 생성할 자동매매 봇 모듈 (독립적)
│   ├── __init__.py
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings_manager.py     # 설정 관리 클래스 (UI 입력 저장/로드)
│   │   └── default_config.json     # 기본 설정 템플릿
│   ├── core/
│   │   ├── __init__.py
│   │   ├── bot_engine.py           # 자동매매 봇 핵심 엔진
│   │   ├── signal_generator.py      # 시그널 생성 (기존 분석 결과 활용)
│   │   └── position_manager.py     # 포지션 관리
│   ├── collectors/
│   │   ├── __init__.py
│   │   ├── data_collector.py       # 기존 DataLoader 활용 (읽기 전용)
│   │   └── market_data.py          # 시장 데이터 수집 (업비트 API)
│   ├── strategies/
│   │   ├── __init__.py
│   │   ├── data_driven_strategy.py # 데이터 기반 전략 (기존 RiskPredictor 활용)
│   │   └── premium_filter.py       # 김치 프리미엄 필터
│   ├── execution/
│   │   ├── __init__.py
│   │   ├── order_executor.py       # 주문 실행 (업비트 API)
│   │   └── balance_manager.py      # 잔고 관리
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── logger.py               # 로깅 유틸리티
│   │   ├── notifier.py             # 텔레그램 알림
│   │   └── validators.py           # 입력 검증
│   └── ui/
│       ├── __init__.py
│       └── trading_page.py         # Streamlit UI 페이지
├── app/
│   └── pages/
│       └── trading_bot_page.py     # 메인 Streamlit 앱에서 호출할 페이지 (기존 메뉴에 추가)
├── install_trading_bot.py            # 설치 스크립트
├── build_executable.py               # 실행 파일 빌드 스크립트
└── requirements_trading_bot.txt     # 봇 전용 의존성
```

## 중요 원칙 (기존 시스템 보호)

1. **데이터베이스 읽기 전용**: 기존 `data/project.db`는 읽기만 하고 절대 수정하지 않음
2. **독립적인 설정 파일**: `trading_bot/config/` 디렉토리에 별도 설정 파일 사용
3. **기존 모듈 래핑**: 기존 `DataLoader`, `RiskPredictor` 등을 래핑하여 사용하되 원본 수정 금지
4. **별도 로그 파일**: `logs/trading_bot.log`로 분리
5. **메뉴 추가만**: 기존 Streamlit 메뉴에 새 항목만 추가, 기존 항목 수정 금지

## 개발 단계별 TO-DO List

### Phase 1: 프로젝트 구조 및 설정 관리 시스템

#### 1.1 프로젝트 폴더 구조 생성
- [ ] `trading_bot/` 디렉토리 생성
- [ ] `trading_bot/config/`, `core/`, `collectors/`, `strategies/`, `execution/`, `utils/`, `ui/` 서브디렉토리 생성
- [ ] 각 디렉토리에 `__init__.py` 파일 생성
- [ ] 기본 패키지 구조 확인

#### 1.2 설정 관리 시스템 개발
**파일**: `trading_bot/config/settings_manager.py`

**기능**:
- UI에서 입력받은 API 키, ID, 비밀번호 등을 안전하게 저장
- JSON 파일로 저장 (암호화 옵션 제공)
- 설정 로드/저장/검증 기능
- 기본값 제공

**구현 내용**:
```python
class SettingsManager:
    - __init__(config_path: Path)
    - load_settings() -> Dict
    - save_settings(settings: Dict) -> bool
    - validate_settings(settings: Dict) -> Tuple[bool, str]
    - get_default_settings() -> Dict
    - encrypt_sensitive_data(data: str) -> str  # 선택적
    - decrypt_sensitive_data(data: str) -> str  # 선택적
```

**설정 파일 위치**: `trading_bot/config/user_settings.json` (gitignore에 추가)

**테스트**:
- [ ] 설정 저장/로드 테스트
- [ ] 유효성 검증 테스트
- [ ] 기본값 로드 테스트
- [ ] 파일 권한 테스트

#### 1.3 기본 설정 템플릿 생성
**파일**: `trading_bot/config/default_config.json`

**포함 항목**:
```json
{
  "api": {
    "upbit_access_key": "",
    "upbit_secret_key": "",
    "binance_api_key": "",
    "binance_secret_key": ""
  },
  "telegram": {
    "bot_token": "",
    "chat_id": ""
  },
  "database": {
    "use_supabase": false,
    "supabase_url": "",
    "supabase_key": "",
    "sqlite_path": "../data/project.db"
  },
  "trading": {
    "target_coin": "BTC",
    "initial_capital": 1000000,
    "max_position_size": 0.3,
    "stop_loss_pct": -0.05,
    "take_profit_pct": 0.10
  },
  "strategy": {
    "volatility_window": 5,
    "negative_premium_threshold": -0.01,
    "low_premium_threshold": 0.02
  }
}
```

### Phase 2: 데이터 수집 및 분석 모듈 통합 (읽기 전용)

#### 2.1 기존 프로젝트 모듈 래핑 (읽기 전용)
**파일**: `trading_bot/collectors/data_collector.py`

**중요**: 기존 모듈을 수정하지 않고 래핑만 수행

**기능**:
- 기존 `DataLoader` 클래스 래핑 (읽기 전용)
- 기존 `RiskPredictor` 클래스 래핑
- 기존 `FeatureEngineer` 클래스 래핑
- 데이터 조회 인터페이스 통일

**구현 내용**:
```python
class DataCollector:
    - __init__(settings: Dict)
    - _init_data_loader()  # 기존 DataLoader 인스턴스 생성
    - _init_risk_predictor()  # 기존 RiskPredictor 인스턴스 생성
    - get_risk_prediction(coin: str, date: str) -> Dict
    - get_feature_values(coin: str) -> Dict
    - get_current_price(coin: str) -> float
    - get_premium_data(coin: str) -> Dict
    - get_whale_data(coin: str) -> Dict
```

**주의사항**:
- 기존 모듈의 경로를 동적으로 찾아서 import
- 기존 DB 연결은 읽기 전용으로만 사용
- 에러 발생 시 기존 서비스에 영향 없도록 처리

**테스트**:
- [ ] 기존 모듈 정상 로드 테스트
- [ ] 데이터 조회 기능 테스트 (읽기 전용 확인)
- [ ] 에러 핸들링 테스트
- [ ] 기존 서비스 영향 없음 확인

#### 2.2 시장 데이터 수집 모듈
**파일**: `trading_bot/collectors/market_data.py`

**기능**:
- 업비트 API를 통한 실시간 가격 조회
- 오더북 데이터 수집 (선택)
- 거래소 잔고 조회

**의존성**: `pyupbit` 패키지 사용

**테스트**:
- [ ] API 연결 테스트
- [ ] 데이터 수집 테스트
- [ ] Rate limit 처리 테스트
- [ ] API 키 검증 테스트

### Phase 3: 시그널 생성 및 전략 모듈

#### 3.1 데이터 기반 시그널 생성기
**파일**: `trading_bot/strategies/data_driven_strategy.py`

**기능**:
- 기존 `RiskPredictor`의 고변동성 확률 활용
- 특성 중요도 기반 가중치 적용 (`data/models/risk_ai_metadata.json` 로드)
- 동적 변수 분석
- 매수/매도 시그널 점수 계산

**구현 내용**:
```python
class DataDrivenStrategy:
    - __init__(settings: Dict, data_collector: DataCollector)
    - _load_feature_importance() -> Dict
    - calculate_buy_signal_score(coin: str) -> Dict
    - calculate_sell_signal_score(coin: str, entry_price: float) -> Dict
    - _evaluate_feature_for_buy(feature: str, value: float) -> float
    - _evaluate_dynamic_variables(feature_values: Dict) -> float
```

**특성 중요도 로드**:
- `data/models/risk_ai_metadata.json`에서 `feature_importance` 읽기
- 없는 경우 기본값 사용

**테스트**:
- [ ] 시그널 점수 계산 정확도 테스트
- [ ] 특성 중요도 반영 테스트
- [ ] 동적 변수 평가 테스트
- [ ] 엣지 케이스 테스트 (데이터 부족, NaN 처리 등)

#### 3.2 김치 프리미엄 필터
**파일**: `trading_bot/strategies/premium_filter.py`

**기능**:
- 업비트 vs 바이낸스 프리미엄 계산 (기존 DataLoader 활용)
- 역프/낮은 김프 감지
- 전역 매수 필터 적용

**테스트**:
- [ ] 프리미엄 계산 정확도 테스트
- [ ] 필터 로직 테스트

### Phase 4: 주문 실행 및 포지션 관리

#### 4.1 주문 실행 모듈
**파일**: `trading_bot/execution/order_executor.py`

**기능**:
- 업비트 API를 통한 매수/매도 주문
- 주문 상태 조회
- 주문 취소
- 에러 처리 및 재시도

**구현 내용**:
```python
class OrderExecutor:
    - __init__(api_key: str, api_secret: str)
    - place_buy_order(market: str, price: float, quantity: float) -> Dict
    - place_sell_order(market: str, price: float, quantity: float) -> Dict
    - get_order_status(uuid: str) -> Dict
    - cancel_order(uuid: str) -> bool
    - _retry_on_error(func, max_retries: int) -> Any
```

**의존성**: `pyupbit` 패키지 사용

**테스트**:
- [ ] API 인증 테스트
- [ ] 주문 실행 테스트 (모의투자 환경)
- [ ] 에러 처리 테스트
- [ ] 재시도 로직 테스트

#### 4.2 잔고 관리 모듈
**파일**: `trading_bot/execution/balance_manager.py`

**기능**:
- 잔고 조회
- 포지션 크기 계산
- 리스크 관리 (최대 포지션 비율 등)

**테스트**:
- [ ] 잔고 조회 테스트
- [ ] 포지션 크기 계산 테스트

#### 4.3 포지션 관리 모듈
**파일**: `trading_bot/core/position_manager.py`

**기능**:
- 현재 포지션 상태 추적
- 진입/청산 기록
- 수익률 계산
- 포지션 데이터 저장 (별도 파일, DB 수정 안 함)

**포지션 저장 위치**: `trading_bot/data/positions.json` (gitignore)

**테스트**:
- [ ] 포지션 추적 테스트
- [ ] 수익률 계산 테스트

### Phase 5: 봇 엔진 코어

#### 5.1 자동매매 봇 엔진
**파일**: `trading_bot/core/bot_engine.py`

**기능**:
- 메인 루프 실행
- 시그널 생성 및 주문 실행 통합
- 상태 관리 (실행 중/중지)
- 스레드 안전성 보장

**구현 내용**:
```python
class TradingBotEngine:
    - __init__(settings: Dict)
    - start() -> bool
    - stop() -> bool
    - is_running() -> bool
    - get_status() -> Dict
    - _main_loop() -> None
    - _check_and_execute() -> None
```

**주의사항**:
- 백그라운드 스레드로 실행
- Streamlit과의 통합 고려 (세션 상태 관리)

**테스트**:
- [ ] 봇 시작/중지 테스트
- [ ] 메인 루프 실행 테스트
- [ ] 상태 관리 테스트
- [ ] 스레드 안전성 테스트

### Phase 6: Streamlit UI 개발

#### 6.1 설정 입력 UI
**파일**: `trading_bot/ui/trading_page.py`

**기능**:
- API 키/시크릿 입력 폼
- 텔레그램 설정 입력
- 거래 파라미터 설정
- 설정 저장/로드
- 설정 검증 및 피드백

**UI 구성**:
- **설정 탭**: API 키, 텔레그램, 거래 파라미터 입력
- **모니터링 탭**: 현재 포지션, 수익률, 로그 표시
- **제어 탭**: 봇 시작/중지, 상태 확인

**구현 내용**:
```python
def render():
    - st.tabs(["설정", "모니터링", "제어"])
    - 설정 탭: 입력 폼, 저장 버튼
    - 모니터링 탭: 실시간 상태 표시
    - 제어 탭: 시작/중지 버튼, 상태 표시
```

**테스트**:
- [ ] UI 렌더링 테스트
- [ ] 입력 검증 테스트
- [ ] 설정 저장/로드 테스트
- [ ] 봇 제어 기능 테스트

#### 6.2 메인 앱 통합 (기존 메뉴에 추가만)
**파일**: `app/pages/trading_bot_page.py`

**기능**:
- `trading_bot.ui.trading_page` 모듈 호출
- 기존 페이지와 동일한 구조

**수정 파일**: `app/main.py`
- 사이드바에 "🤖 자동매매 봇" 메뉴 추가 (기존 메뉴 수정 안 함)
- 페이지 라우팅 추가

**주의사항**:
- 기존 메뉴 항목은 절대 수정하지 않음
- 새 항목만 추가

**테스트**:
- [ ] 페이지 통합 테스트
- [ ] 메뉴 네비게이션 테스트
- [ ] 기존 메뉴 정상 작동 확인

### Phase 7: 유틸리티 및 알림

#### 7.1 로깅 시스템
**파일**: `trading_bot/utils/logger.py`

**기능**:
- 파일 로깅 (별도 파일)
- 콘솔 로깅
- 로그 레벨 관리
- 로그 로테이션

**로그 파일 위치**: `logs/trading_bot.log` (기존 로그와 분리)

**테스트**:
- [ ] 로그 파일 생성 테스트
- [ ] 로그 레벨 테스트
- [ ] 로그 로테이션 테스트

#### 7.2 텔레그램 알림
**파일**: `trading_bot/utils/notifier.py`

**기능**:
- 매수/매도 체결 알림
- 에러 알림
- 일일 리포트

**테스트**:
- [ ] 알림 전송 테스트

#### 7.3 입력 검증
**파일**: `trading_bot/utils/validators.py`

**기능**:
- API 키 형식 검증
- 숫자 입력 검증
- 필수 필드 검증

**테스트**:
- [ ] 각 검증 함수 테스트

### Phase 8: 설치 및 배포

#### 8.1 설치 스크립트
**파일**: `install_trading_bot.py`

**기능**:
- 의존성 패키지 설치
- 필요한 디렉토리 생성
- 설정 파일 초기화
- 권한 설정

**구현 내용**:
```python
def install():
    - pip install -r requirements_trading_bot.txt
    - create_directories()
    - initialize_config()
    - set_permissions()
    - verify_installation()
```

**테스트**:
- [ ] 깨끗한 환경에서 설치 테스트
- [ ] 의존성 충돌 테스트
- [ ] 기존 패키지 영향 없음 확인

#### 8.2 실행 파일 빌드
**파일**: `build_executable.py`

**기능**:
- PyInstaller를 사용한 실행 파일 생성
- Streamlit 앱 포함
- 필요한 리소스 파일 포함
- 단일 실행 파일 또는 디렉토리 형태

**구현 내용**:
```python
def build():
    - PyInstaller spec 파일 생성
    - 실행 파일 빌드
    - 테스트 실행
    - 배포 패키지 생성
```

**테스트**:
- [ ] 실행 파일 생성 테스트
- [ ] 실행 파일 독립 실행 테스트
- [ ] 다른 PC에서 실행 테스트

#### 8.3 의존성 관리
**파일**: `requirements_trading_bot.txt`

**포함 패키지**:
- 기존 requirements.txt의 패키지 (읽기용)
- pyupbit (업비트 API)
- pyinstaller (빌드용, 개발 의존성)
- 추가 필요한 패키지

**주의사항**:
- 기존 requirements.txt와 충돌하지 않도록 버전 명시

### Phase 9: 통합 테스트

#### 9.1 단위 테스트
- [ ] 각 모듈별 단위 테스트 작성
- [ ] 테스트 커버리지 확인 (최소 70%)
- [ ] 기존 서비스 영향 없음 확인

#### 9.2 통합 테스트
- [ ] 전체 플로우 테스트 (시그널 생성 → 주문 실행)
- [ ] 에러 시나리오 테스트
- [ ] 장시간 실행 안정성 테스트
- [ ] 기존 분석 서비스 정상 작동 확인

#### 9.3 모의투자 테스트
- [ ] 업비트 모의투자 환경에서 테스트
- [ ] 실제 주문 실행 테스트 (소액)
- [ ] 수익률 검증

### Phase 10: 문서화 및 사용자 가이드

#### 10.1 개발 문서
- [ ] API 문서 작성
- [ ] 아키텍처 문서 작성
- [ ] 코드 주석 보완

#### 10.2 사용자 가이드
- [ ] 설치 가이드 작성
- [ ] 설정 가이드 작성
- [ ] 사용법 가이드 작성
- [ ] FAQ 작성
- [ ] 트러블슈팅 가이드

## 단계별 테스트 과정

### 테스트 환경 구성
1. 테스트용 가상환경 생성
2. 테스트용 설정 파일 생성 (모의투자)
3. 테스트용 데이터 준비
4. 기존 서비스 정상 작동 확인

### Phase별 테스트 체크리스트

#### Phase 1 테스트
- [ ] 폴더 구조 생성 확인
- [ ] 설정 저장/로드 기능 테스트
- [ ] 기존 파일/디렉토리 영향 없음 확인

#### Phase 2 테스트
- [ ] 기존 모듈 통합 테스트 (읽기 전용 확인)
- [ ] 데이터 조회 기능 테스트
- [ ] API 연결 테스트
- [ ] 기존 분석 서비스 정상 작동 확인

#### Phase 3 테스트
- [ ] 시그널 생성 정확도 테스트
- [ ] 전략 로직 테스트
- [ ] 엣지 케이스 테스트

#### Phase 4 테스트
- [ ] 주문 API 테스트 (모의투자)
- [ ] 잔고 관리 테스트
- [ ] 포지션 추적 테스트

#### Phase 5 테스트
- [ ] 봇 엔진 시작/중지 테스트
- [ ] 메인 루프 실행 테스트
- [ ] 상태 관리 테스트

#### Phase 6 테스트
- [ ] UI 렌더링 테스트
- [ ] 입력 검증 테스트
- [ ] 페이지 통합 테스트
- [ ] 기존 메뉴 정상 작동 확인

#### Phase 7 테스트
- [ ] 로깅 기능 테스트
- [ ] 알림 전송 테스트

#### Phase 8 테스트
- [ ] 설치 스크립트 테스트
- [ ] 실행 파일 빌드 테스트
- [ ] 실행 파일 독립 실행 테스트

#### Phase 9 통합 테스트
- [ ] 전체 플로우 시뮬레이션
- [ ] 장시간 실행 안정성 테스트
- [ ] 모의투자 환경 테스트
- [ ] **기존 데이터 수집 서비스 정상 작동 확인**
- [ ] **기존 분석 서비스 메뉴 정상 작동 확인**

## 주요 고려사항

### 기존 시스템 보호
1. **데이터베이스**: 기존 `data/project.db`는 읽기 전용으로만 사용, 절대 수정하지 않음
2. **설정 파일**: `trading_bot/config/`에 별도 설정 파일 사용, 기존 설정 파일 수정 금지
3. **로깅**: `logs/trading_bot.log`로 분리, 기존 로그 파일 수정 금지
4. **메뉴**: 기존 Streamlit 메뉴 항목은 수정하지 않고 새 항목만 추가
5. **모듈**: 기존 모듈은 래핑만 하고 원본 수정 금지

### 보안
1. **API 키 암호화**: 민감한 정보는 암호화하여 저장 (선택적)
2. **파일 권한**: 설정 파일은 적절한 권한 설정
3. **환경 변수**: 가능한 경우 환경 변수 사용

### 에러 처리
1. **재시도 로직**: 모든 API 호출에 재시도 로직 포함
2. **에러 격리**: 에러 발생 시 기존 서비스에 영향 없도록 처리
3. **로깅**: 모든 에러 상세 로깅

### 사용자 경험
1. **명확한 피드백**: UI에서 명확한 상태 표시
2. **설정 검증**: 입력 시 즉시 검증 및 피드백
3. **에러 메시지**: 사용자 친화적인 에러 메시지

## 예상 개발 기간

- Phase 1-2: 3일 (구조 및 데이터 통합, 기존 시스템 영향 없음 확인)
- Phase 3-4: 5일 (전략 및 실행)
- Phase 5-6: 4일 (엔진 및 UI, 기존 메뉴 영향 없음 확인)
- Phase 7-8: 3일 (유틸리티 및 배포)
- Phase 9-10: 3일 (테스트 및 문서화, 기존 서비스 정상 작동 확인)

**총 예상 기간**: 약 18일

## 배포 체크리스트

배포 전 확인 사항:
- [ ] 기존 데이터 수집 서비스 정상 작동
- [ ] 기존 분석 서비스 메뉴 정상 작동
- [ ] 기존 데이터베이스 수정 없음 확인
- [ ] 모든 테스트 통과
- [ ] 문서화 완료
- [ ] 사용자 가이드 작성 완료

