# 원인 분석 및 수정 사항 리스트

## 실행 결과 요약
- 수집된 거래: 4건 (USDC - Avalanche만)
- BNB: 0개 주소 조회됨
- USDC Solana: 주소 형식 오류 (EVM 형식으로 저장됨)
- XRP: 주소는 정상이지만 거래 0건
- 대부분 네트워크: 거래 0건

---

## 문제 1: BNB 주소가 0개로 조회됨

### 원인 분석
1. **조건 불일치**: 
   - 스크립트에서 `chain_type='BSC' AND name_tag='Binance Coin'` 조건으로 조회
   - 실제 whale_address 테이블의 BSC 체인 데이터는 `name_tag`가 다양함:
     - `None` (null)
     - `'BSC: Token Hub'`
     - `'Binance 7'`
     - `'Null: 0x000...dEaD'`
     - 등등
   - `name_tag='Binance Coin'`인 BSC 주소가 없음

2. **데이터 업로드 시 문제**:
   - `upload_bnb_usdc_xrp_to_whale_address.py`에서 BNB CSV를 업로드할 때 `name_tag='Binance Coin'`으로 설정
   - 하지만 기존 BSC 데이터와 ID가 중복되어 건너뛰었을 가능성
   - 또는 CSV 파일 자체에 BNB 데이터가 없었을 가능성

### 수정 사항
1. **get_whale_addresses_by_coin 함수 수정** (`collect_bnb_usdc_xrp_transactions_2025_may_june.py` 71번 줄):
   - 현재: `eq('name_tag', 'Binance Coin')` 조건 사용
   - 수정: BSC 체인의 모든 주소를 조회하거나, name_tag 조건을 제거
   - 또는: BSC 체인에서 `name_tag IS NULL` 또는 특정 패턴의 주소만 조회

2. **whale_address 테이블 데이터 확인**:
   - BSC 체인에 실제 BNB 고래 주소가 있는지 확인
   - 없다면 `bnb_mainnet_richlist_top100.csv`를 다시 업로드 필요

3. **대안 조회 방법**:
   - `chain_type='BSC'`만으로 조회 (name_tag 조건 제거)
   - 또는 `chain_type='BSC' AND (name_tag IS NULL OR name_tag LIKE '%Binance%')` 조건 사용

---

## 문제 2: Solana USDC 주소 형식 오류

### 원인 분석
1. **주소 형식 불일치**:
   - whale_address 테이블의 Solana 주소가 EVM 형식(0x로 시작)으로 저장됨
   - 예: `0x5e8af2a74e34fceffafbb2af92c9507b9f81ecb0`
   - Solana 주소는 Base58 인코딩 형식이어야 함 (예: `EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`)

2. **CSV 파일 확인 필요**:
   - `usdc_solana_richlist_top100.csv` 파일의 주소 형식 확인
   - CoinCarp에서 Solana 주소를 잘못 수집했을 가능성

3. **API 호출 실패**:
   - Solscan API에 EVM 형식 주소를 전달하여 404 오류 발생
   - Solana 주소 형식 검증 로직 필요

### 수정 사항
1. **주소 형식 검증 추가** (`collect_bnb_usdc_xrp_transactions_2025_may_june.py`):
   - `fetch_solana_usdc_transactions` 함수에서 주소 형식 검증
   - EVM 형식(0x로 시작) 주소는 건너뛰기
   - Solana 주소 형식(Base58, 32-44자)만 처리

2. **CSV 파일 재확인**:
   - `usdc_solana_richlist_top100.csv` 파일 확인
   - 주소가 올바른 Solana 형식인지 확인
   - 잘못되었다면 CoinCarp에서 다시 수집 필요

3. **whale_address 테이블 데이터 수정**:
   - Solana 주소가 EVM 형식으로 저장된 경우 수정 필요
   - 올바른 Solana 주소로 업데이트

4. **주소 형식 검증 함수 추가**:
   ```python
   def is_valid_solana_address(address: str) -> bool:
       # Solana 주소는 Base58 인코딩, 32-44자
       # EVM 형식(0x로 시작)이 아닌지 확인
       return not address.startswith('0x') and 32 <= len(address) <= 44
   ```

---

## 문제 3: XRP 거래 수집 실패

### 원인 분석
1. **주소 형식은 정상**:
   - XRP 주소는 올바른 형식(r로 시작)으로 저장되어 있음
   - 예: `r38a3PtqW3M7LRESgaR4dyHjg3AxAmiZCt`

2. **API 호출 실패**:
   - 일부 주소에서 403 Forbidden 오류 발생
   - XRPScan API의 rate limit 또는 접근 제한 가능성

3. **날짜 필터링 문제**:
   - 2025년 5-6월은 미래 날짜이므로 실제 거래가 없을 수 있음
   - 또는 XRPScan API 응답 형식이 예상과 다를 수 있음

### 수정 사항
1. **XRPScan API 응답 형식 확인**:
   - `fetch_xrp_transactions` 함수에서 API 응답 구조 확인
   - 실제 응답 형식에 맞게 파싱 로직 수정

2. **날짜 필터링 로직 개선**:
   - XRPScan API가 날짜 필터링을 지원하는지 확인
   - 지원하지 않으면 전체 거래를 수집한 후 Python에서 필터링

3. **에러 처리 강화**:
   - 403 오류 발생 시 재시도 로직 추가
   - Rate limit 처리 (더 긴 대기 시간)

4. **대안 API 사용**:
   - XRPScan API가 실패하면 XRP Ledger Public API (JSON-RPC) 사용
   - `account_tx` 메소드로 거래 조회

5. **날짜 범위 확인**:
   - 2025년 5-6월이 미래 날짜인지 확인
   - 현재 날짜가 2025년 이전이면 실제 거래가 없을 수 있음

---

## 문제 4: 대부분 네트워크에서 거래 0건

### 원인 분석
1. **날짜 범위 문제**:
   - 2025년 5-6월은 미래 날짜일 가능성
   - 실제로 해당 기간에 거래가 없을 수 있음

2. **블록 번호 계산 실패**:
   - `calculate_block_range_by_date` 함수가 실패하여 전체 블록 범위로 조회
   - 날짜 필터링이 제대로 작동하지 않았을 수 있음

3. **API 키 부족**:
   - Polygon, Arbitrum, Optimism, Base 등은 별도 API 키 필요
   - 현재 ETHERSCAN_API_KEY만 사용 중
   - API 키가 없으면 수집 실패

4. **컨트랙트 주소 불일치**:
   - USDC 컨트랙트 주소가 네트워크별로 다를 수 있음
   - 잘못된 컨트랙트 주소로 조회 시 거래 0건

### 수정 사항
1. **날짜 범위 검증**:
   - 현재 날짜 확인
   - 2025년 5-6월이 미래인지 확인
   - 미래라면 과거 날짜로 테스트 필요

2. **블록 번호 계산 로직 개선**:
   - `calculate_block_range_by_date` 함수의 에러 처리 강화
   - 실패 시 로그 출력하여 원인 파악
   - 각 네트워크별로 블록 번호 계산 방법 확인

3. **API 키 설정 확인**:
   - PolygonScan, Arbiscan, Optimism, BaseScan API 키 필요
   - `.env` 파일에 추가 또는 발급 필요
   - API 키가 없으면 해당 네트워크 건너뛰기 로직 추가

4. **컨트랙트 주소 검증**:
   - 각 네트워크의 USDC 컨트랙트 주소 확인
   - 잘못된 주소인지 검증

5. **디버깅 로그 추가**:
   - API 호출 URL, 파라미터, 응답 로그 출력
   - 거래가 0건인 이유 파악을 위한 상세 로그

---

## 문제 5: 코드 로직 개선 필요

### 수정 사항
1. **주소 형식 검증 함수 추가**:
   - EVM 주소 검증 (0x + 40자 hex)
   - Solana 주소 검증 (Base58, 32-44자)
   - XRP 주소 검증 (r로 시작, 25-35자)
   - 각 네트워크별로 올바른 형식만 처리

2. **에러 처리 개선**:
   - API 호출 실패 시 상세한 에러 메시지
   - 주소별 실패 원인 기록
   - 재시도 로직 추가

3. **로깅 강화**:
   - 각 단계별 상세 로그
   - API 응답 샘플 출력 (디버깅용)
   - 수집된 거래 수, 필터링된 거래 수 등 통계

4. **날짜 필터링 검증**:
   - 수집된 거래의 block_timestamp 확인
   - 날짜 범위를 벗어난 거래가 있는지 검증
   - 필터링 로직이 제대로 작동하는지 확인

---

## 우선순위별 수정 사항

### 높은 우선순위
1. **BNB 주소 조회 조건 수정** - name_tag 조건 제거 또는 변경
2. **Solana 주소 형식 검증** - EVM 형식 주소 필터링
3. **날짜 범위 검증** - 현재 날짜 확인 및 테스트

### 중간 우선순위
4. **XRPScan API 응답 형식 확인 및 수정**
5. **블록 번호 계산 로직 개선**
6. **API 키 설정 확인 및 추가**

### 낮은 우선순위
7. **로깅 및 디버깅 강화**
8. **에러 처리 개선**
9. **주소 형식 검증 함수 추가**

---

## 수정이 필요한 파일

1. **collect_bnb_usdc_xrp_transactions_2025_may_june.py**
   - `get_whale_addresses_by_coin` 함수 (71번 줄)
   - `fetch_solana_usdc_transactions` 함수 (주소 형식 검증 추가)
   - `fetch_xrp_transactions` 함수 (API 응답 형식 확인)
   - `calculate_block_range_by_date` 함수 (에러 처리 강화)
   - 주소 형식 검증 함수 추가

2. **upload_bnb_usdc_xrp_to_whale_address.py** (선택사항)
   - BNB CSV 업로드 시 name_tag 확인
   - Solana 주소 형식 검증 추가

3. **.env 파일** (선택사항)
   - PolygonScan, Arbiscan, Optimism, BaseScan API 키 추가

