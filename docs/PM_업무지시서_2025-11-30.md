# 프로젝트 비평 및 업무 지시서

**작성일**: 2025-11-30  
**작성자**: PM  
**검토 대상**: 배포된 서비스 전체

---

## 📋 실행 요약

현재 배포된 서비스를 검토한 결과, **4가지 중대한 문제점**이 발견되었습니다:

1. **거래소 유입/유출 데이터가 전부 0** - 핵심 기능 미작동
2. **ETH 데이터 대량 누락** - BTC와 동일한 기간/종류 데이터 부재
3. **동적 변수 분석이 단순 시각화에 그침** - 가격 상관관계 검증 없음
4. **고래 데이터 분석이 통계적 검증 없음** - 변수별 가격 영향도 미검증

---

## 🔴 문제점 1: 거래소 유입/유출 데이터가 전부 0

### 현황
- `whale_daily_stats` 테이블에 BTC 274건, ETH 1,409건의 레코드 존재
- **하지만 모든 `exchange_inflow_usd`, `exchange_outflow_usd`, `net_flow_usd` 값이 0**
- 거래소 유입/유출 분석 기능이 완전히 작동하지 않음

### 원인 분석 필요
1. `whale_transactions` 테이블의 `transaction_direction` 컬럼이 제대로 업데이트되지 않았을 가능성
2. `aggregate_whale_stats.py`의 집계 로직에서 필터링 조건이 잘못되었을 가능성
3. Supabase와 SQLite 간 데이터 동기화 문제

### 담당자: **데이터 엔지니어**

#### 업무 지시
1. **즉시 조사** (`scripts/subprojects/risk_ai/diagnose_exchange_flow.py` 생성)
   - `whale_transactions` 테이블에서 `transaction_direction` 값 분포 확인
   - `exchange_inflow`, `exchange_outflow` 레이블이 실제로 존재하는지 확인
   - Supabase와 SQLite 양쪽 모두 확인

2. **데이터 검증 스크립트 작성**
   ```python
   # 예시: transaction_direction 값 분포 확인
   SELECT 
       transaction_direction,
       COUNT(*) as count,
       SUM(amount_usd) as total_amount
   FROM whale_transactions
   WHERE coin_symbol IN ('BTC', 'ETH')
   GROUP BY transaction_direction
   ```

3. **문제 해결 방안**
   - 만약 `transaction_direction`이 NULL이거나 잘못된 값이면:
     - `sql/update_direction_and_unknown.sql` 재실행
     - 또는 `scripts/label_transaction_direction_fast_batch.py` 재실행
   - 만약 집계 로직 문제면:
     - `aggregate_whale_stats.py`의 필터링 조건 수정
     - `exchange_inflow`/`exchange_outflow` 판단 로직 재검토

4. **재집계 실행**
   - 문제 해결 후 `aggregate_whale_stats.py --rebuild-all` 실행
   - 2022-01-01부터 현재까지 전체 재집계

5. **검증**
   - 재집계 후 `whale_daily_stats`에서 `exchange_inflow_usd > 0`인 레코드 확인
   - 최소 10% 이상의 레코드가 0이 아닌 값이어야 함

**마감일**: 2025-12-01 (1일)

---

## 🔴 문제점 2: ETH 데이터 대량 누락

### 현황
- BTC는 2022-01-01부터 현재까지 데이터 수집됨
- ETH는 BTC와 동일한 기간/종류의 데이터가 부족
- 파생상품 지표, 온체인 지표, 고래 거래 데이터 모두 ETH에서 누락

### 담당자: **데이터 수집 담당자**

#### 업무 지시
1. **ETH 데이터 수집 현황 점검**
   - 다음 데이터 소스별로 BTC vs ETH 비교:
     - `binance_futures_metrics` (ETHUSDT)
     - `futures_extended_metrics` (ETHUSDT)
     - `whale_daily_stats` (ETH)
     - `whale_weekly_stats` (ETH)
     - `bitinfocharts_whale` (ETH)

2. **누락된 데이터 수집**
   - BTC와 동일한 기간 (2022-01-01 ~ 현재) 수집
   - BTC와 동일한 종류의 데이터:
     - Binance Futures Funding Rate (ETHUSDT)
     - Binance Futures Open Interest (ETHUSDT)
     - Long/Short Ratio, Taker Ratio (ETHUSDT)
     - Bybit Futures Funding Rate/OI (ETHUSDT)
     - Whale Daily/Weekly Stats (ETH)

3. **수집 스크립트 실행**
   ```bash
   # Binance Futures Metrics (ETHUSDT)
   python scripts/subprojects/risk_ai/backfill_binance_futures.py --symbol ETHUSDT
   
   # Extended Metrics (ETHUSDT)
   python scripts/subprojects/risk_ai/backfill_futures_extended_metrics.py --symbol ETHUSDT
   
   # Bybit Futures (ETHUSDT)
   python scripts/subprojects/risk_ai/backfill_bybit_futures.py --symbol ETHUSDT
   
   # Whale Stats 재집계 (ETH 포함)
   python scripts/subprojects/risk_ai/aggregate_whale_stats.py --rebuild-all --coins BTC,ETH
   ```

4. **데이터 품질 검증**
   - BTC와 ETH의 데이터 건수 비교
   - 날짜 범위 일치 여부 확인
   - NULL/0 값 비율 비교 (5% 이내 차이 허용)

**마감일**: 2025-12-02 (2일)

---

## 🔴 문제점 3: 동적 변수 분석이 단순 시각화에 그침

### 현황
- 현재 `dynamic_variables_page.py`는 변화량(delta), 가속도(accel), 기울기(slope)만 시각화
- **가격과의 상관관계 검증이 없음**
- **백테스트가 없음**
- 동적 변수가 실제로 가격 예측에 유용한지 알 수 없음

### 담당자: **데이터 분석가 + ML 엔지니어**

#### 업무 지시

##### 3-1. 상관관계 분석 모듈 개발

**파일**: `scripts/subprojects/risk_ai/analyze_dynamic_correlation.py`

**기능**:
1. **종속변수 정의**
   - `price_change_1d`: 1일 후 가격 변화율
   - `price_change_7d`: 7일 후 가격 변화율
   - `volatility_change_1d`: 1일 후 변동성 변화율
   - `price_direction_1d`: 1일 후 가격 방향 (상승/하락, binary)

2. **독립변수 (동적 변수)**
   - `volatility_delta`, `volatility_accel`, `volatility_slope`
   - `oi_delta`, `oi_accel`, `oi_slope`
   - `funding_delta`, `funding_accel`
   - `taker_ratio_delta`, `net_flow_delta`
   - 기타 모든 동적 변수

3. **상관관계 계산**
   - Pearson 상관계수
   - Spearman 상관계수 (비선형 관계)
   - 시차 상관관계 (lag 0, 1, 2, 3, 7일)

4. **통계적 유의성 검정**
   - p-value < 0.05인 변수만 보고
   - False Discovery Rate (FDR) 보정

5. **결과 저장**
   - `data/analysis/dynamic_correlation_results.csv`
   - 컬럼: `variable`, `target`, `correlation`, `p_value`, `lag`

##### 3-2. 백테스트 모듈 개발

**파일**: `scripts/subprojects/risk_ai/backtest_dynamic_signals.py`

**기능**:
1. **시그널 생성**
   - 각 동적 변수에 대해 임계값 기반 시그널 생성
   - 예: `oi_accel > 0.1` → 매수 시그널
   - 예: `volatility_delta > 0.02` → 리스크 경고

2. **백테스트 실행**
   - 2022-01-01 ~ 현재까지 롤링 윈도우 백테스트
   - 각 시그널의 수익률 계산
   - Sharpe Ratio, Maximum Drawdown 계산

3. **결과 리포트**
   - 변수별 수익률 순위
   - 최적 임계값 추천
   - `data/analysis/dynamic_backtest_results.csv`

##### 3-3. 대시보드 통합

**파일**: `app/pages/dynamic_variables_page.py` 수정

**추가 기능**:
1. **상관관계 섹션 추가**
   - 동적 변수와 가격 변화율 간 상관계수 히트맵
   - 시차별 상관관계 그래프
   - 통계적 유의성 표시

2. **백테스트 결과 섹션 추가**
   - 변수별 예측 정확도
   - 수익률 비교 차트
   - 최적 시그널 조합 추천

**마감일**: 2025-12-05 (5일)

---

## 🔴 문제점 4: 고래 데이터 분석이 통계적 검증 없음

### 현황
- 고래 데이터 변수들(유입/유출, 활성 주소, 대형 거래 등)이 단순 시각화만 됨
- 각 변수가 코인 가격(정적 가격, 변동성, 방향)에 미치는 영향이 검증되지 않음
- 변수별 중요도나 예측력이 알려지지 않음

### 담당자: **데이터 분석가**

#### 업무 지시

##### 4-1. 변수 분류 및 분석 방법 정의

**변수 분류**:
1. **온체인 변수**
   - `exchange_inflow_usd`, `exchange_outflow_usd`, `net_flow_usd`
   - `active_addresses`, `large_tx_count`, `avg_tx_size_usd`
   - `whale_to_whale_usd`

2. **파생상품 변수**
   - `sum_open_interest`, `avg_funding_rate`
   - `long_short_ratio`, `taker_buy_sell_ratio`
   - `top_trader_long_short_ratio`

3. **고래 집중도 변수**
   - `top100_richest_pct`, `whale_conc_change_7d`

**분석 방법 분류**:
1. **상관관계 분석** (Correlation Analysis)
2. **그레인저 인과관계 검정** (Granger Causality Test)
3. **선형 회귀 분석** (Linear Regression)
4. **랜덤 포레스트 피처 중요도** (Feature Importance)
5. **SHAP 값 분석** (SHAP Values)

##### 4-2. 종합 상관관계 분석 스크립트 개발

**파일**: `scripts/subprojects/risk_ai/analyze_whale_price_correlation.py`

**기능**:
1. **종속변수 정의**
   - `price_static`: 정적 가격 (USD)
   - `price_change_1d`, `price_change_7d`, `price_change_30d`: 가격 변화율
   - `volatility_1d`, `volatility_7d`: 변동성
   - `price_direction_1d`, `price_direction_7d`: 가격 방향 (상승/하락)

2. **독립변수 (모든 고래/온체인 변수)**
   - 온체인 변수 (유입/유출, 활성 주소 등)
   - 파생상품 변수 (OI, Funding Rate 등)
   - 고래 집중도 변수

3. **분석 실행**
   - 각 변수-타겟 조합에 대해:
     - Pearson/Spearman 상관계수
     - 시차별 상관관계 (0, 1, 2, 3, 7일)
     - 그레인저 인과관계 검정 (p-value)
     - 선형 회귀 계수 및 R²
     - 랜덤 포레스트 피처 중요도
     - SHAP 값 (샘플링)

4. **결과 저장**
   - `data/analysis/whale_price_correlation_full.csv`
   - 컬럼: `variable`, `target`, `correlation`, `lag`, `granger_pvalue`, `regression_coef`, `r_squared`, `feature_importance`, `shap_value`

##### 4-3. 대시보드 통합

**파일**: `app/pages/comprehensive_dashboard_page.py` 수정

**추가 기능**:
1. **변수별 가격 영향도 섹션**
   - 변수별 상관계수 순위
   - 시차별 영향도 그래프
   - 그레인저 인과관계 검정 결과

2. **예측력 비교 섹션**
   - 변수별 R² 비교
   - 피처 중요도 차트
   - SHAP 값 시각화

3. **최적 변수 조합 추천**
   - 상위 N개 변수 조합의 예측 정확도
   - 변수 간 다중공선성 확인

**마감일**: 2025-12-07 (7일)

---

## 📊 우선순위 및 일정

| 우선순위 | 문제점 | 담당자 | 마감일 | 상태 |
|---------|--------|--------|--------|------|
| **P0** | 거래소 유입/유출 0 문제 | 데이터 엔지니어 | 2025-12-01 | 🔴 긴급 |
| **P0** | ETH 데이터 수집 | 데이터 수집 담당자 | 2025-12-02 | 🔴 긴급 |
| **P1** | 동적 변수 상관관계 분석 | 데이터 분석가 + ML 엔지니어 | 2025-12-05 | 🟡 중요 |
| **P1** | 고래 데이터 통계적 검증 | 데이터 분석가 | 2025-12-07 | 🟡 중요 |

---

## ✅ 검수 기준

### 문제점 1 (거래소 유입/유출)
- [ ] `whale_daily_stats`에서 `exchange_inflow_usd > 0`인 레코드가 전체의 10% 이상
- [ ] 최소 30일 이상의 연속 데이터에서 0이 아닌 값 존재
- [ ] 대시보드에서 거래소 유입/유출 차트가 정상 표시

### 문제점 2 (ETH 데이터)
- [ ] BTC와 ETH의 데이터 건수 차이가 5% 이내
- [ ] 날짜 범위가 동일 (2022-01-01 ~ 현재)
- [ ] 모든 데이터 소스에서 ETH 데이터 존재 확인

### 문제점 3 (동적 변수 분석)
- [ ] 상관관계 분석 결과 파일 생성
- [ ] 백테스트 결과 파일 생성
- [ ] 대시보드에 상관관계/백테스트 섹션 추가
- [ ] 최소 3개 이상의 동적 변수가 가격과 유의미한 상관관계 (p < 0.05)

### 문제점 4 (고래 데이터 검증)
- [ ] 종합 상관관계 분석 결과 파일 생성
- [ ] 대시보드에 변수별 영향도 섹션 추가
- [ ] 최소 5개 이상의 변수가 가격과 유의미한 상관관계 (p < 0.05)
- [ ] 그레인저 인과관계 검정 결과 포함

---

## 📝 참고사항

1. **데이터 소스 확인**
   - SQLite: `data/project.db`
   - Supabase: 환경변수로 연결
   - 두 데이터베이스 모두 확인 필요

2. **코드 리뷰**
   - 모든 새로 작성된 스크립트는 코드 리뷰 필수
   - 테스트 코드 작성 권장

3. **문서화**
   - 분석 결과는 `docs/analysis/` 디렉토리에 저장
   - 분석 방법론 문서화 필수

4. **성능**
   - 대용량 데이터 분석 시 샘플링 또는 배치 처리 고려
   - 실행 시간이 1시간 이상이면 백그라운드 실행

---

**PM 서명**: _______________  
**승인일**: 2025-11-30

