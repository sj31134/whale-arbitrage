# ì „ì²´ ì½”ë“œ ë¦¬ë·° ë° ìˆ˜ì •ì‚¬í•­

**ì‘ì„±ì¼**: 2025-12-03  
**ëª©ì **: ë¡œì»¬ê³¼ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ê°„ ì°¨ì´ì ì„ ì°¾ì•„ ìˆ˜ì •

---

## ğŸ” ë°œê²¬ëœ ê·¼ë³¸ ì›ì¸

### ë¬¸ì œ 1: `get_available_dates` í•¨ìˆ˜ê°€ Supabaseë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
**ì¦ìƒ**: í´ë¼ìš°ë“œì—ì„œ "btc ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤" ì˜¤ë¥˜  
**ì›ì¸**: 
- Supabase ì‚¬ìš© ì‹œ `self.conn`ì´ `None`ì´ë¯€ë¡œ ë°”ë¡œ `None, None` ë°˜í™˜
- `validate_date_range`ì—ì„œ `get_available_dates`ë¥¼ í˜¸ì¶œí•˜ë©´ í•­ìƒ ì‹¤íŒ¨

**ìˆ˜ì •**:
- Supabaseë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `binance_futures_metrics` í…Œì´ë¸”ì—ì„œ ë‚ ì§œ ë²”ìœ„ ì¡°íšŒ
- SQLite í´ë°± ë¡œì§ ìœ ì§€

### ë¬¸ì œ 2: `get_available_dates_list` í•¨ìˆ˜ê°€ Supabaseë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
**ì¦ìƒ**: ë‚ ì§œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨  
**ì›ì¸**: Supabase ì‚¬ìš© ì‹œ SQLite ì¿¼ë¦¬ë§Œ ì‹œë„

**ìˆ˜ì •**:
- Supabaseë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `binance_futures_metrics` í…Œì´ë¸”ì—ì„œ ë‚ ì§œ ëª©ë¡ ì¡°íšŒ
- SQLite í´ë°± ë¡œì§ ìœ ì§€

### ë¬¸ì œ 3: `load_risk_data`ì—ì„œ Supabase ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì²˜ë¦¬ ë¶€ì¡±
**ì¦ìƒ**: ë°ì´í„°ê°€ ì—†ì–´ë„ ë¹ˆ DataFrameì„ ë°˜í™˜í•˜ì§€ ì•ŠìŒ  
**ì›ì¸**: `if futures_response.data:` ì²´í¬ë§Œ í•˜ê³ , ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê³„ì† ì§„í–‰

**ìˆ˜ì •**:
- `if futures_response.data and len(futures_response.data) > 0:` ì²´í¬ ì¶”ê°€
- ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ DataFrame ë°˜í™˜

### ë¬¸ì œ 4: `load_futures_extended_metrics`ì—ì„œ Supabase ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì²˜ë¦¬ ë¶€ì¡±
**ì¦ìƒ**: ë™ì¼í•œ ë¬¸ì œ  
**ìˆ˜ì •**: ë™ì¼í•˜ê²Œ ìˆ˜ì •

### ë¬¸ì œ 5: `render_exchange_flow`ì—ì„œ Supabaseë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
**ì¦ìƒ**: ê±°ë˜ì†Œ ìœ ì…/ìœ ì¶œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŒ  
**ì›ì¸**: `data_loader.conn`ì„ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ Supabase ì‚¬ìš© ì‹œ ì˜¤ë¥˜ ë°œìƒ

**ìˆ˜ì •**:
- Supabaseë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `whale_daily_stats` í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ
- SQLite í´ë°± ë¡œì§ ìœ ì§€

---

## ğŸ“‹ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### 1. `app/utils/data_loader.py`
- `get_available_dates`: Supabase ì§€ì› ì¶”ê°€
- `get_available_dates_list`: Supabase ì§€ì› ì¶”ê°€
- `load_risk_data`: Supabase ë°ì´í„° ì—†ì„ ë•Œ ë¹ˆ DataFrame ë°˜í™˜
- `load_futures_extended_metrics`: Supabase ë°ì´í„° ì—†ì„ ë•Œ ë¹ˆ DataFrame ë°˜í™˜

### 2. `app/pages/risk_dashboard_page.py`
- `render_exchange_flow`: Supabase ì§€ì› ì¶”ê°€
- `logging` import ì¶”ê°€

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ë¡œì»¬ í™˜ê²½ í…ŒìŠ¤íŠ¸
```
âœ… get_available_dates (BTC): ì„±ê³µ
âœ… load_risk_data (BTC): 26í–‰ ë¡œë“œ ì„±ê³µ
âœ… load_futures_extended_metrics (BTC): 28í–‰ ë¡œë“œ ì„±ê³µ
âœ… get_available_dates (ETH): ì„±ê³µ
âœ… load_risk_data (ETH): 28í–‰ ë¡œë“œ ì„±ê³µ
âœ… load_futures_extended_metrics (ETH): 28í–‰ ë¡œë“œ ì„±ê³µ
```

### í´ë¼ìš°ë“œ í™˜ê²½ í…ŒìŠ¤íŠ¸ (ì˜ˆìƒ)
- Supabase ì—°ê²° ì„±ê³µ ì‹œ ë™ì¼í•œ ê²°ê³¼ ì˜ˆìƒ
- Supabase ì—°ê²° ì‹¤íŒ¨ ì‹œ SQLite í´ë°±ìœ¼ë¡œ ë™ì¼í•œ ê²°ê³¼ ì˜ˆìƒ

---

## ğŸ”§ ìˆ˜ì • ìƒì„¸ ë‚´ìš©

### ìˆ˜ì • 1: `get_available_dates` Supabase ì§€ì›

**ìˆ˜ì • ì „:**
```python
if not hasattr(self, 'conn') or self.conn is None:
    return None, None
```

**ìˆ˜ì • í›„:**
```python
# Supabase ìš°ì„  ì‚¬ìš© (í´ë¼ìš°ë“œ í™˜ê²½)
if self.use_supabase:
    try:
        supabase = self._get_supabase_client()
        if supabase:
            response = supabase.table("binance_futures_metrics") \
                .select("date") \
                .eq("symbol", symbol) \
                .order("date") \
                .execute()
            
            if response.data and len(response.data) > 0:
                dates = [row['date'] for row in response.data]
                min_date = min(dates)
                max_date = max(dates)
                return min_date, max_date
            
            return None, None
    except Exception as e:
        logging.warning(f"Supabaseì—ì„œ ë‚ ì§œ ì¡°íšŒ ì‹¤íŒ¨, SQLiteë¡œ í´ë°±: {e}")

# SQLite ì‚¬ìš© (ë¡œì»¬ í™˜ê²½ ë˜ëŠ” Supabase ì‹¤íŒ¨ ì‹œ)
if not hasattr(self, 'conn') or self.conn is None:
    return None, None
```

### ìˆ˜ì • 2: `load_risk_data` ë¹ˆ ë°ì´í„° ì²˜ë¦¬

**ìˆ˜ì • ì „:**
```python
if futures_response.data:
    # ... ì²˜ë¦¬ ...
    return df
```

**ìˆ˜ì • í›„:**
```python
if futures_response.data and len(futures_response.data) > 0:
    # ... ì²˜ë¦¬ ...
    return df
else:
    # Supabaseì—ì„œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ DataFrame ë°˜í™˜
    logging.warning(f"Supabaseì—ì„œ {symbol} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ê¸°ê°„: {start_date} ~ {end_date})")
    return pd.DataFrame()
```

### ìˆ˜ì • 3: `render_exchange_flow` Supabase ì§€ì›

**ìˆ˜ì • ì „:**
```python
flow_df = pd.read_sql(query, data_loader.conn)
```

**ìˆ˜ì • í›„:**
```python
flow_df = pd.DataFrame()

# Supabase ìš°ì„  ì‚¬ìš© (í´ë¼ìš°ë“œ í™˜ê²½)
if data_loader.use_supabase:
    try:
        supabase = data_loader._get_supabase_client()
        if supabase:
            response = supabase.table("whale_daily_stats") \
                .select("date, exchange_inflow_usd, exchange_outflow_usd, net_flow_usd") \
                .eq("coin_symbol", coin) \
                .gte("date", start_date) \
                .lte("date", end_date) \
                .order("date") \
                .execute()
            
            if response.data and len(response.data) > 0:
                flow_df = pd.DataFrame(response.data)
    except Exception as e:
        logging.warning(f"Supabaseì—ì„œ ê±°ë˜ì†Œ ìœ ì…/ìœ ì¶œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")

# SQLite ì‚¬ìš© (ë¡œì»¬ í™˜ê²½ ë˜ëŠ” Supabase ì‹¤íŒ¨ ì‹œ)
if flow_df.empty and data_loader.conn is not None:
    flow_df = pd.read_sql(query, data_loader.conn)
```

---

## âœ… ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë¡œì»¬ í™˜ê²½
- [x] `get_available_dates` ì •ìƒ ì‘ë™
- [x] `load_risk_data` ì •ìƒ ì‘ë™
- [x] `load_futures_extended_metrics` ì •ìƒ ì‘ë™
- [x] `render_exchange_flow` ì •ìƒ ì‘ë™ (ë¡œì»¬ì—ì„œëŠ” SQLite ì‚¬ìš©)

### í´ë¼ìš°ë“œ í™˜ê²½ (ì˜ˆìƒ)
- [ ] `get_available_dates` Supabaseì—ì„œ ì •ìƒ ì‘ë™
- [ ] `load_risk_data` Supabaseì—ì„œ ì •ìƒ ì‘ë™
- [ ] `load_futures_extended_metrics` Supabaseì—ì„œ ì •ìƒ ì‘ë™
- [ ] `render_exchange_flow` Supabaseì—ì„œ ì •ìƒ ì‘ë™

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ì½”ë“œ ìˆ˜ì • ì™„ë£Œ í™•ì¸**
   - [x] ëª¨ë“  í•¨ìˆ˜ì— Supabase ì§€ì› ì¶”ê°€
   - [x] ë¹ˆ ë°ì´í„° ì²˜ë¦¬ ê°œì„ 
   - [x] ë¡œì»¬ í…ŒìŠ¤íŠ¸ í†µê³¼

2. **GitHub í‘¸ì‹œ ë° ì¬ë°°í¬**
   - [ ] ìˆ˜ì •ëœ ì½”ë“œ ì»¤ë°‹
   - [ ] GitHub í‘¸ì‹œ
   - [ ] Streamlit Cloud ìë™ ì¬ë°°í¬ í™•ì¸

3. **í´ë¼ìš°ë“œ í…ŒìŠ¤íŠ¸**
   - [ ] ë°°í¬ëœ ì•± ì ‘ì†
   - [ ] ê° í˜ì´ì§€ë³„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
   - [ ] ë¡œì»¬ê³¼ ê²°ê³¼ ë¹„êµ
   - [ ] ì˜¤ë¥˜ ì—†ì´ ì •ìƒ ì‘ë™ í™•ì¸

---

## ğŸ“ ì°¸ê³ 

- **ë¡œì»¬ URL**: http://localhost:8501/
- **í´ë¼ìš°ë“œ URL**: https://whale-arbitrage-qwodzy8wpnhpgxaxt23rj8.streamlit.app/
- **í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸**: `scripts/test_all_pages.py`

