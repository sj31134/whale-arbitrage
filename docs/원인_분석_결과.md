# 🔍 whale_address 테이블 업로드 문제 원인 분석

## 📊 현재 상황

### Supabase 현황
- **전체 레코드**: 3,400건
- **체인별 분포**:
  - BSC: 100건 (BSC001~BSC100)
  - BTC: 264건
  - DOT: 100건
  - ETH: 272건
  - LINK: 100건
  - LTC: 64건
  - SOL: 100건

### CSV 파일 현황
- **전체 레코드**: 1,500건
- **체인별 분포**:
  - BTC: 300건 (BTC001~BTC300)
  - ETH: 300건 (ETH001~ETH300)
  - LTC: 300건 (LTC001~LTC300)
  - DOGE: 300건 (DOGE001~DOGE300)
  - VTC: 300건 (VTC001~VTC300)

### ID 매칭 현황
- **CSV에 있지만 Supabase에 없는 ID**: 900건
- **Supabase에 있지만 CSV에 없는 ID**: 400건 (BSC, DOT, LINK, SOL 등)
- **공통 ID**: 600건

---

## 🚨 핵심 원인

### **원인 1: PRIMARY KEY 부재 (가장 중요!)**

```sql
CREATE TABLE public.whale_address (
    id text null,           -- ❌ PRIMARY KEY 없음!
    chain_type text null,
    address text null,
    ...
)
```

**문제점:**
- `whale_address` 테이블에 **PRIMARY KEY가 없습니다**
- Supabase의 `upsert()` 메서드는 기본적으로 **PRIMARY KEY 또는 UNIQUE 제약**을 기준으로 작동합니다
- PRIMARY KEY가 없으면 `upsert`가 제대로 작동하지 않습니다

**Supabase upsert 동작 방식:**
1. PRIMARY KEY가 있으면 → 해당 키로 기존 레코드 찾아서 UPDATE
2. PRIMARY KEY가 없으면 → 모든 레코드를 INSERT로 처리하거나 예상치 못한 동작

**현재 코드 (72번 줄):**
```python
response = supabase.table('whale_address').upsert(batch).execute()
```
- `upsert()`에 별도의 `on_conflict` 파라미터가 없음
- PRIMARY KEY가 없어서 upsert가 제대로 작동하지 않음

---

### **원인 2: upsert 기준 키 불일치**

**현재 상황:**
- CSV: BTC001, ETH001, LTC001, DOGE001, VTC001 등
- Supabase: BSC001~BSC100, BTC001~BTC264 등

**문제점:**
- `id` 컬럼만으로는 전역적으로 고유하지 않을 수 있음
- 같은 `id` 값이 다른 `chain_type`에 존재할 수 있음
- PRIMARY KEY가 없어서 `(id, chain_type)` 복합 키로 upsert를 할 수 없음

**예시:**
- 만약 BSC001과 BTC001이 모두 존재한다면, `id`만으로는 구분 불가
- 하지만 현재는 PRIMARY KEY가 없어서 이런 문제가 발생하지 않음 (대신 upsert가 작동하지 않음)

---

### **원인 3: 업로드 스크립트의 upsert 로직 문제**

**현재 코드 분석:**
```python
# 72번 줄
response = supabase.table('whale_address').upsert(batch).execute()
```

**문제점:**
1. `upsert()`에 `on_conflict` 파라미터가 없음
2. PRIMARY KEY가 없어서 어떤 레코드를 업데이트할지 결정할 수 없음
3. 결과적으로 모든 레코드가 INSERT로 처리되거나 무시될 수 있음

**Supabase Python 클라이언트의 upsert 동작:**
- PRIMARY KEY가 있으면: 자동으로 해당 키로 기존 레코드 찾아서 UPDATE
- PRIMARY KEY가 없으면: **예상치 못한 동작** (모두 INSERT 또는 에러)

---

### **원인 4: 데이터 타입 및 형식 불일치 가능성**

**확인 필요:**
- CSV의 `id`가 "BTC001" (문자열)
- Supabase의 `id`가 동일한 형식인지 확인 필요
- 하지만 현재는 PRIMARY KEY 부재가 더 큰 문제

---

## 📋 요약

### **주요 원인:**
1. ✅ **PRIMARY KEY 부재** - 가장 중요한 원인
2. ✅ **upsert 기준 키 불일치** - PRIMARY KEY가 없어서 발생
3. ✅ **업로드 스크립트의 upsert 로직 문제** - PRIMARY KEY 부재로 인한 부작용

### **왜 데이터가 추가되지 않는가?**
1. `whale_address` 테이블에 PRIMARY KEY가 없음
2. `upsert()` 메서드가 PRIMARY KEY를 기준으로 작동하는데, PRIMARY KEY가 없어서 제대로 작동하지 않음
3. 결과적으로 CSV의 데이터가 INSERT되지 않거나, 기존 데이터(BSC001~BSC100)만 남아있음

### **해결 방법 (참고용, 지금은 실행하지 않음):**
1. **옵션 1**: 테이블에 PRIMARY KEY 추가
   ```sql
   ALTER TABLE whale_address ADD PRIMARY KEY (id);
   -- 또는 복합 키
   ALTER TABLE whale_address ADD PRIMARY KEY (id, chain_type);
   ```

2. **옵션 2**: 업로드 스크립트 수정
   - `upsert()` 대신 `insert()` 사용
   - 또는 `update()` + `insert()` 조합으로 수동 처리

3. **옵션 3**: `on_conflict` 파라미터 사용 (PostgreSQL의 경우)
   - 하지만 Supabase Python 클라이언트에서는 PRIMARY KEY가 필요

---

## 🔍 추가 확인 사항

1. **Supabase 대시보드에서 테이블 스키마 확인**
   - `whale_address` 테이블의 PRIMARY KEY 여부
   - UNIQUE 제약이 있는지

2. **실제 업로드 로그 확인**
   - 업로드 스크립트 실행 시 에러가 발생했는지
   - `upsert()`가 성공했다고 나오지만 실제로는 데이터가 추가되지 않았는지

3. **Supabase API 응답 확인**
   - `upsert()` 응답에서 실제로 몇 건이 INSERT/UPDATE되었는지 확인



