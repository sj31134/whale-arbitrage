# 추가 분석 내용 및 서비스 통합 방안

## 📊 추가 분석 내용 요약

### 1. Binance Vision 아카이브 데이터 수집

#### 수집된 데이터
- **OI (미결제약정) 데이터**: 1,425건 (유효성 99.8%)
  - 기간: 2022-01-01 ~ 2025-11-27
  - 이전: 유효 데이터 2% → 현재: 99.8% (약 50배 개선)

- **확장 파생 지표** (`futures_extended_metrics`): 1,303건
  - Top Trader 롱/숏 비율: 1,115건
  - Taker 매수/매도 비율: 1,301건
  - Bybit 펀딩비 및 OI 데이터

#### 데이터 소스
- Binance Vision 아카이브: `https://data.binance.vision/data/futures/um/daily/metrics/BTCUSDT/`
- 일별 ZIP 파일 다운로드 및 CSV 파싱
- 자동화 스크립트: `scripts/subprojects/risk_ai/download_binance_vision_metrics.py`

---

### 2. 동적 변수 (Dynamic Variables) 추가

#### 추가된 동적 변수 (17개)

**1차 미분 (변화율)**
- `volatility_delta`: 변동성 일일 변화율
- `oi_delta`: OI 일일 변화율
- `funding_delta`: 펀딩비 일일 변화율
- `taker_ratio_delta`: Taker 비율 변화율
- `net_flow_delta`: 거래소 순유입 변화율

**2차 미분 (가속도)**
- `volatility_accel`: 변동성 가속도
- `oi_accel`: OI 가속도
- `funding_accel`: 펀딩비 가속도

**추세 기울기 (5일 이동평균)**
- `volatility_slope`: 변동성 추세 기울기
- `oi_slope`: OI 추세 기울기
- `funding_slope`: 펀딩비 추세 기울기

**안정성 지표**
- `volatility_delta_stability`: 변동성 변화의 안정성 (표준편차)
- `oi_delta_stability`: OI 변화의 안정성

**모멘텀 지표**
- `long_short_momentum`: 롱/숏 비율 모멘텀 (3일 변화)
- `ext_ls_momentum`: 확장 롱/숏 모멘텀
- `funding_taker_momentum`: 펀딩-Taker 결합 모멘텀
- `vol_oi_accel_product`: 변동성-OI 가속도 곱

#### 동적 변수의 의미
- **변화율 (Delta)**: 시장이 얼마나 빠르게 변하는지
- **가속도 (Acceleration)**: 변화의 속도가 가속되는지 감속되는지
- **기울기 (Slope)**: 장기 추세 방향
- **안정성 (Stability)**: 변화가 일관적인지 불규칙한지

---

### 3. 모델 성능 개선

#### 성능 비교

| 모델 | AUC-ROC | 개선율 |
|------|---------|--------|
| XGBoost (정적 변수) | 0.6017 | 기준 |
| XGBoost (동적 변수 포함) | 0.6316 | **+4.96%** |
| Hybrid Ensemble | 0.6514 | **+3.13%** (추가) |

#### 주요 개선 사항
- **동적 변수 기여도**: 43.97%
- **상위 중요 특성**:
  1. `volatility_slope` (7.29%)
  2. `volatility_delta_stability` (6.83%)
  3. `oi_delta` (5.68%)
  4. `avg_funding_rate` (5.34%)
  5. `taker_buy_sell_ratio` (5.28%)

---

### 4. Supabase 동기화

- **총 12개 테이블** 동기화 완료
- **총 18,130건** 데이터 업로드
- 주요 테이블 완전 일치 (10개)

---

## 🎯 서비스 통합 방안

### 현재 서비스 구조

```
메인 메뉴:
1. 📊 차익거래 비용 계산기
2. 🎯 최적 전략 추천
3. ⚠️ 리스크 예측 대시보드 (기존)
4. 📊 역사적 리스크 분석
5. 🔍 특성 중요도 분석
```

### 제안 1: 기존 "리스크 예측 대시보드" 개선 (권장)

#### 개선 사항

**A. 동적 지표 섹션 확장** (이미 부분 구현됨)
- 현재: 기본적인 동적 지표 표시
- 개선: 
  - 시계열 차트 추가 (변화율/가속도 추이)
  - 동적 변수 상관관계 히트맵
  - 동적 변수 기여도 시각화

**B. 파생상품 지표 섹션 신규 추가**
```python
def render_derivatives_metrics():
    """파생상품 지표 시각화"""
    st.subheader("📈 파생상품 지표 분석")
    
    # 1. OI (미결제약정) 추이
    # 2. 롱/숏 비율 추이
    # 3. Taker 매수/매도 비율
    # 4. Top Trader 포지션 비율
    # 5. 펀딩비 추이
```

**C. 모델 비교 기능 추가**
- 사이드바에 모델 선택 옵션 (이미 구현됨)
- 모델별 예측 결과 비교 차트
- 성능 지표 비교 테이블

---

### 제안 2: 신규 메뉴 추가

#### 옵션 A: "📊 파생상품 지표 분석" 페이지

**위치**: 메인 메뉴에 추가

**기능**:
1. **OI (미결제약정) 분석**
   - OI 추이 차트
   - OI 변화율/가속도 분석
   - OI와 가격 상관관계

2. **롱/숏 비율 분석**
   - 글로벌 롱/숏 비율
   - Top Trader 롱/숏 비율
   - 롱/숏 비율 모멘텀

3. **Taker 매수/매도 압력**
   - Taker 비율 추이
   - 매수/매도 압력 히트맵
   - Taker 비율 변화율

4. **펀딩비 분석**
   - 펀딩비 추이
   - 펀딩비 Z-Score
   - 펀딩비 변화율/가속도

**파일**: `app/pages/derivatives_analysis_page.py`

---

#### 옵션 B: "📈 동적 변수 분석" 페이지

**위치**: 메인 메뉴에 추가

**기능**:
1. **동적 변수 시계열 분석**
   - 변화율 (Delta) 추이
   - 가속도 (Acceleration) 추이
   - 기울기 (Slope) 추이

2. **동적 변수 상관관계**
   - 동적 변수 간 상관관계 히트맵
   - 주요 동적 변수와 리스크 점수 상관관계

3. **동적 변수 기여도**
   - 특성 중요도 차트 (동적 변수만)
   - 동적 변수 기여도: 43.97% 시각화

4. **동적 변수 예측력 분석**
   - 동적 변수 포함/미포함 모델 비교
   - 성능 개선 효과 시각화

**파일**: `app/pages/dynamic_variables_page.py`

---

#### 옵션 C: "🔬 모델 성능 비교" 페이지

**위치**: 메인 메뉴에 추가

**기능**:
1. **모델 성능 비교**
   - AUC-ROC 비교 차트
   - Precision/Recall/F1 비교
   - 혼동 행렬 비교

2. **모델별 예측 결과 비교**
   - 동일 날짜에 대한 각 모델 예측 비교
   - 예측 분포 비교

3. **특성 중요도 비교**
   - 정적 변수 vs 동적 변수 중요도
   - 모델별 특성 중요도 차이

**파일**: `app/pages/model_comparison_page.py`

---

### 제안 3: 통합 대시보드 (종합)

#### "📊 리스크 분석 종합 대시보드" 페이지

**기능 통합**:
1. **현재 리스크 예측** (기존 기능)
2. **파생상품 지표** (신규)
3. **동적 변수 분석** (신규)
4. **모델 성능 비교** (신규)
5. **거래소 유입/유출** (기존 기능)

**레이아웃**:
```
┌─────────────────────────────────────────┐
│  리스크 점수 (대형 카드)                │
├─────────────────┬───────────────────────┤
│ 파생상품 지표   │ 동적 변수 분석        │
├─────────────────┼───────────────────────┤
│ 모델 비교       │ 거래소 유입/유출     │
└─────────────────┴───────────────────────┘
```

---

## 🚀 구현 우선순위

### Phase 1: 기존 페이지 개선 (즉시)
1. ✅ 리스크 예측 대시보드에 동적 지표 섹션 확장
2. ✅ 파생상품 지표 섹션 추가
3. ✅ 모델 선택 기능 개선

### Phase 2: 신규 페이지 추가 (단기)
1. 📊 파생상품 지표 분석 페이지
2. 📈 동적 변수 분석 페이지

### Phase 3: 고급 기능 (중기)
1. 🔬 모델 성능 비교 페이지
2. 📊 통합 대시보드

---

## 📝 구현 예시 코드

### 파생상품 지표 섹션 추가 예시

```python
# app/pages/risk_dashboard_page.py에 추가

def render_derivatives_metrics(data_loader, target_date, coin):
    """파생상품 지표 시각화"""
    st.subheader("📈 파생상품 지표 분석")
    
    try:
        # futures_extended_metrics 데이터 로드
        metrics_df = data_loader.load_futures_extended_metrics(
            start_date=target_date - timedelta(days=30),
            end_date=target_date,
            symbol=f"{coin}USDT"
        )
        
        if metrics_df.empty:
            st.info("💡 파생상품 지표 데이터가 없습니다.")
            return
        
        # 1. OI 추이
        col1, col2 = st.columns(2)
        with col1:
            st.markdown("**미결제약정 (OI) 추이**")
            fig = px.line(metrics_df, x='date', y='bybit_oi', 
                         title='OI 추이 (30일)')
            st.plotly_chart(fig, use_container_width=True)
        
        with col2:
            st.markdown("**롱/숏 비율 추이**")
            fig = px.line(metrics_df, x='date', y='top_trader_long_short_ratio',
                         title='Top Trader 롱/숏 비율')
            st.plotly_chart(fig, use_container_width=True)
        
        # 2. Taker 비율
        st.markdown("**Taker 매수/매도 비율**")
        fig = px.line(metrics_df, x='date', y='taker_buy_sell_ratio',
                     title='Taker 매수/매도 비율 (1.0 이상 = 매수 압력)')
        fig.add_hline(y=1.0, line_dash="dash", line_color="gray")
        st.plotly_chart(fig, use_container_width=True)
        
    except Exception as e:
        st.info(f"💡 파생상품 지표를 불러올 수 없습니다: {str(e)}")
```

---

## 📊 데이터 흐름

```
Binance Vision 아카이브
    ↓
download_binance_vision_metrics.py
    ↓
SQLite (project.db)
    ↓
sync_sqlite_to_supabase.py
    ↓
Supabase
    ↓
DataLoader (app/utils/data_loader.py)
    ↓
FeatureEngineer (동적 변수 생성)
    ↓
RiskPredictor (예측)
    ↓
Streamlit UI (시각화)
```

---

## ✅ 체크리스트

### 데이터 수집
- [x] Binance Vision 아카이브 데이터 수집
- [x] OI 데이터 유효성 99.8% 달성
- [x] 확장 파생 지표 수집
- [x] Supabase 동기화

### 모델 개선
- [x] 동적 변수 추가 (17개)
- [x] 모델 성능 4.96% 개선
- [x] 하이브리드 앙상블 구현
- [x] 모델 평가 및 비교

### 서비스 통합
- [ ] 리스크 대시보드에 파생상품 지표 섹션 추가
- [ ] 동적 변수 분석 섹션 확장
- [ ] 모델 비교 기능 추가
- [ ] 신규 페이지 개발 (선택사항)

---

## 🎯 결론

**추가 분석 내용**:
1. Binance Vision 아카이브에서 OI 및 파생 지표 대량 수집
2. 동적 변수 17개 추가로 시장 변화의 속도/가속도 분석 가능
3. 모델 성능 4.96% 개선 (동적 변수) + 3.13% 추가 개선 (앙상블)

**서비스 통합 방안**:
- **즉시**: 기존 리스크 대시보드에 파생상품 지표 섹션 추가
- **단기**: 파생상품 지표 분석 페이지 신규 추가
- **중기**: 동적 변수 분석 전용 페이지 추가

**권장 사항**: 
기존 리스크 예측 대시보드를 확장하는 것이 가장 효율적입니다. 이미 동적 지표 섹션이 부분 구현되어 있으므로, 파생상품 지표 섹션만 추가하면 됩니다.

